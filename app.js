var A=Object.defineProperty;var T=(i,t,e)=>t in i?A(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var u=(i,t,e)=>T(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}})();const E={0:"Single LED",1:"RGB",2:"UV",3:"Servo",4:"Piezo",5:"Button",6:"Accel",7:"Proximity"};function P(i){if(i==null)return[];const t=[];for(let e=0;e<16;e+=1)if((i&1<<e)!==0){const s=E[e];t.push(s??`Capability ${e}`)}return t}function _(i){const t=i.trim();if(t.length===0)return null;const e=t.startsWith("0x")||t.startsWith("0X")?Number.parseInt(t,16):Number.parseInt(t,10);return!Number.isFinite(e)||Number.isNaN(e)||e<0||e>255?null:e}function N(i){if(!i)return;const t=i.match(/0x[0-9a-fA-F]{1,2}|\d{1,3}/g);if(!t||t.length<2)return;const e=[];for(const s of t){const a=_(s);if(a===null)return;e.push(a)}if(!(e.length<2))return e[0]&255|(e[1]&255)<<8}function O(i){if(!i)return;const t=N(i.capabilities_mask_bytes);return t!==void 0?t:i.capabilities_mask}class R{constructor(t){u(this,"baseUrl");this.baseUrl=t}async getStatus(){return this.requestJson("/api/status")}async getConfig(){return this.requestJson("/api/config")}async saveConfig(t){return await this.requestJson("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),{ok:!0}}async restart(){await this.requestJson("/api/restart",{method:"POST"})}async factoryReset(){await this.requestJson("/api/factory-reset",{method:"POST"})}async sendMood(t){return await this.requestJson("/api/mood",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mood_id:t})}),{ok:!0}}async requestJson(t,e){const s=await fetch(`${this.baseUrl}${t}`,e);if(!s.ok)throw new Error(`ESP API error: ${s.status}`);return await s.json()}}const q={border:2,light:"#f8fafc",dark:"#0a0a0c"};function L(){const i=globalThis.qrcodegen;return!i||!i.QrCode||!i.QrCode.encodeText?null:i}function V(i,t){const e=i.size,s=t.border,a=e+s*2;let n="";for(let r=0;r<e;r++)for(let c=0;c<e;c++)if(i.getModule(c,r)){const h=c+s,g=r+s;n+=`M${h},${g}h1v1h-1z`}return[`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${a} ${a}" shape-rendering="crispEdges" role="img" aria-label="QR code">`,`<rect width="100%" height="100%" fill="${t.light}"/>`,`<path d="${n}" fill="${t.dark}"/>`,"</svg>"].join("")}function x(i,t,e){if(!i)return;const s=L();if(!s){i.textContent="QR library missing",i.classList.add("qr-missing");return}const a={...q,...e},n=s.QrCode.encodeText(t,s.QrCode.Ecc.MEDIUM);i.innerHTML=V(n,a),i.classList.remove("qr-missing")}const Q=120;function M(){const i=globalThis.BarcodeDetector;return i?new i({formats:["qr_code"]}):null}function $(){return globalThis.jsQR??null}function k(i){return i.readyState>=2?Promise.resolve():new Promise(t=>{i.addEventListener("loadedmetadata",()=>t(),{once:!0})})}async function B(i,t){var v,y,S,b;if(!((v=navigator.mediaDevices)!=null&&v.getUserMedia))throw new Error("Camera API not available");(y=t.onStatus)==null||y.call(t,"Requesting camera...");const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});i.srcObject=e,i.setAttribute("playsinline","true"),await i.play(),await k(i);const s=M(),a=s?null:$();if(!s&&!a)throw e.getTracks().forEach(f=>f.stop()),(S=t.onStatus)==null||S.call(t,"QR decoder missing"),new Error("No QR decoder available (BarcodeDetector or jsQR)");const n=a?document.createElement("canvas"):null,r=n?n.getContext("2d",{willReadFrequently:!0}):null;let c=!0,h=0;(b=t.onStatus)==null||b.call(t,"Scanning...");const g=()=>{c&&(c=!1,e.getTracks().forEach(f=>f.stop()),i.pause(),i.srcObject=null)},w=async()=>{var I;if(!c)return;const f=performance.now();if(f-h<Q){requestAnimationFrame(w);return}h=f;try{if(s){const l=await s.detect(i);if(l.length>0&&l[0].rawValue){t.onResult(l[0].rawValue),g();return}}else if(a&&r&&n){const l=i.videoWidth,p=i.videoHeight;if(l>0&&p>0){n.width=l,n.height=p,r.drawImage(i,0,0,l,p);const C=r.getImageData(0,0,l,p),m=a(C.data,l,p);if(m!=null&&m.data){t.onResult(m.data),g();return}}}}catch(l){(I=t.onError)==null||I.call(t,l)}requestAnimationFrame(w)};return requestAnimationFrame(w),{stop:g}}function o(i){const t=document.getElementById(i);if(!t)throw new Error(`Element with id "${i}" not found`);return t}function d(i){return o(i)}class D{constructor(t,e){u(this,"api");u(this,"views",{});u(this,"status",null);u(this,"config",null);u(this,"playId",null);u(this,"scanSession",null);u(this,"nextViewTimeout",null);u(this,"actions",{"next-view":()=>{const t=Object.keys(this.viewInit);if(t.length===0)return;const s=(t.findIndex(a=>{var n;return(n=this.views[a])==null?void 0:n.active})+1)%t.length;this.openView(t[s])},"previous-view":()=>{const t=Object.keys(this.viewInit);if(t.length===0)return;const s=(t.findIndex(a=>{var n;return(n=this.views[a])==null?void 0:n.active})-1+t.length)%t.length;this.openView(t[s])},"generate-play-id":()=>{this.playId=this.createPlayId(),this.renderPlayQr()},"scan-friend":()=>{this.startScan()},"ping-friend":()=>alert("Pinging friend..."),"save-config":async()=>{this.setHeaderStatus("Saving..."),o("save-config-btn").setAttribute("disabled","true"),await this.api.saveConfig({wifi_ssid:d("wifi_ssid").value,wifi_pass:d("wifi_pass").value,ap_ssid:d("ap_ssid").value,ap_pass:d("ap_pass").value}),this.setHeaderStatus("Configuration saved"),o("save-config-btn").removeAttribute("disabled")},"restart-device":async()=>{this.setHeaderStatus("Restarting device..."),await this.api.restart(),setTimeout(()=>window.location.reload(),2e3)}});u(this,"viewInit",{"splash-view":async()=>{var t;this.setHeaderStatus("Connecting..."),this.status=await this.api.getStatus(),this.setHeaderStatus(((t=this.status)==null?void 0:t.name)??"Unknown Device"),this.nextViewTimeout=setTimeout(()=>{this.openView("home-view")},2e3)},"home-view":async()=>{var t,e,s,a,n,r;this.status||(this.status=await this.api.getStatus()),this.setHeaderStatus(((t=this.status)==null?void 0:t.name)??"Unknown Device"),o("device-name").textContent=((e=this.status)==null?void 0:e.name)??"-",o("energy-level").textContent=`${((s=this.status)==null?void 0:s.energy)??"-"}%`,o("network-type").textContent=(a=this.status)!=null&&a.ap_only?"AP Mode":"Online",o("mood-value").textContent=((n=this.status)==null?void 0:n.mood)??"-",o("ip-address").textContent=((r=this.status)==null?void 0:r.ip)??"-"},"mood-view":async()=>{this.setHeaderStatus("Mood Configuration")},"p2p-view":async()=>{this.setHeaderStatus("P2P Connection"),this.renderPlayQr()},"settings-view":async()=>{var s,a,n,r,c;this.status||(this.status=await this.api.getStatus()),this.config||(this.config=await this.api.getConfig()),this.setHeaderStatus("Configuration"),d("vittra-name").value=((s=this.status)==null?void 0:s.name)??"-",d("wifi_ssid").value=((a=this.config)==null?void 0:a.wifi_ssid)??"",d("wifi_pass").value=((n=this.config)==null?void 0:n.wifi_pass)??"",d("ap_ssid").value=((r=this.config)==null?void 0:r.ap_ssid)??"",d("ap_pass").value=((c=this.config)==null?void 0:c.ap_pass)??"";const t=O(this.status),e=P(t);o("caps-list").innerHTML=e.length>0?e.map(h=>`<span class="cap-tag">${h}</span>`).join(""):'<span class="cap-tag">None</span>',this.renderOwnerQr()}});this.api=new R(t),this.initEventListeners(e)}setHeaderStatus(t){o("header-status").textContent=t}closeAllViews(){for(const t in this.views){const e=this.views[t];e.active&&(e.active=!1,e.root.classList.remove("active"))}this.stopScan()}createPlayId(){var e;const t=new Uint8Array(6);if((e=globalThis.crypto)!=null&&e.getRandomValues)globalThis.crypto.getRandomValues(t);else for(let s=0;s<t.length;s++)t[s]=Math.floor(Math.random()*256);return Array.from(t).map(s=>s.toString(16).padStart(2,"0")).join("")}renderPlayQr(){const t=o("play-id-qr"),e=this.playId??(this.playId=this.createPlayId());x(t,`vittra://play/${e}`)}renderOwnerQr(){var a;const t=o("owner-qr"),e=((a=this.status)==null?void 0:a.name)??"vittra",s=encodeURIComponent(e);x(t,`vittra://owner/${s}`)}setScanStatus(t,e){const s=document.getElementById("scan-qr"),a=document.getElementById("scan-status");a&&(a.textContent=t),s&&s.classList.toggle("scanning",e)}stopScan(){this.scanSession&&(this.scanSession.stop(),this.scanSession=null),this.setScanStatus("Camera idle",!1)}async startScan(){const t=document.getElementById("scan-video");if(t){this.stopScan(),this.setScanStatus("Requesting camera...",!0);try{this.scanSession=await B(t,{onResult:e=>{this.setScanStatus(`Found: ${e}`,!1)},onStatus:e=>{this.setScanStatus(e,!0)},onError:()=>{this.setScanStatus("Scan error",!1)}})}catch(e){this.setScanStatus("QR scan unsupported",!1),alert(e.message)}}}async openView(t){this.nextViewTimeout&&(clearTimeout(this.nextViewTimeout),this.nextViewTimeout=null),this.closeAllViews();let e=this.views[t];e||(this.views[t]={id:t,root:o(t),active:!0},e=this.views[t]),e.active=!0,this.setHeaderStatus("..."),e.root.classList.add("active");const s=this.viewInit[t];s&&await s(e)}initEventListeners(t){t.addEventListener("click",e=>{let s=e.target;for(;s&&s!==t&&!(s.tagName.match(/A|BUTTON/)&&(s.hasAttribute("data-view")||s.hasAttribute("data-action")));)s=s.parentElement;if(!s||s===t)return;e.preventDefault();const a=s.hasAttribute("data-view")?s.getAttribute("data-view"):null,n=s.hasAttribute("data-action")?s.getAttribute("data-action"):null;if(a&&this.openView(a),n){const r=this.actions[n];r?r():alert(`No handler defined for action: ${n}`)}}),t.addEventListener("submit",async e=>{e.preventDefault();const s=e.target;if(s.tagName==="FORM"&&s.hasAttribute("data-action")){const a=s.getAttribute("data-action"),n=a&&this.actions[a];n?n():alert(`No handler defined for action: ${a}`)}})}}async function H(){await new D("",document.getElementById("app")).openView("splash-view")}H();
